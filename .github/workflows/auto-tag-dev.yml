name: Auto-tag Development Versions

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  auto-tag:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Get latest release version
      id: latest_release
      run: |
        # Get all release tags (excluding dev tags) and find the latest
        LATEST_RELEASE=$(git tag --sort=-version:refname | grep -v -E "-(Dev|dev|RC|rc|alpha|beta)" | head -n 1)
        
        # If no release tags exist, start with 0.1.0
        if [ -z "$LATEST_RELEASE" ]; then
          LATEST_RELEASE="0.1.0"
          echo "No release tags found, using default: $LATEST_RELEASE"
        else
          echo "Latest release version: $LATEST_RELEASE"
        fi
        
        echo "version=$LATEST_RELEASE" >> $GITHUB_OUTPUT

    - name: Get next dev increment
      id: dev_increment
      run: |
        LATEST_RELEASE="${{ steps.latest_release.outputs.version }}"
        
        # Find all existing dev tags for this release version
        EXISTING_DEV_TAGS=$(git tag -l "${LATEST_RELEASE}-Dev*" | sort -V)
        
        if [ -z "$EXISTING_DEV_TAGS" ]; then
          # No dev tags exist for this release, start with Dev1
          NEXT_INCREMENT=1
        else
          # Find the highest dev number and increment
          # Escape special characters in LATEST_RELEASE for use in sed
          ESCAPED_LATEST_RELEASE=$(printf '%s\n' "$LATEST_RELEASE" | sed 's/[.\[\*^$+?{}|()]/\\&/g')
          HIGHEST_DEV=$(echo "$EXISTING_DEV_TAGS" | sed "s/${ESCAPED_LATEST_RELEASE}-Dev//g" | sort -n | tail -1)
          NEXT_INCREMENT=$((HIGHEST_DEV + 1))
        fi
        
        NEW_TAG="${LATEST_RELEASE}-Dev${NEXT_INCREMENT}"
        echo "Next dev tag: $NEW_TAG"
        echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

    - name: Check if tag already exists
      id: tag_exists
      run: |
        NEW_TAG="${{ steps.dev_increment.outputs.tag }}"
        if git tag -l | grep -q "^${NEW_TAG}$"; then
          echo "Tag $NEW_TAG already exists"
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "Tag $NEW_TAG does not exist, will create"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Create and push new tag
      if: steps.tag_exists.outputs.exists == 'false'
      run: |
        NEW_TAG="${{ steps.dev_increment.outputs.tag }}"
        COMMIT_SHA="${{ github.sha }}"
        COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
        COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        
        echo "Creating tag: $NEW_TAG"
        echo "Commit: $COMMIT_SHA"
        echo "Message: $COMMIT_MESSAGE"
        echo "Author: $COMMIT_AUTHOR"
        
        # Create annotated tag with commit information
        git tag -a "$NEW_TAG" -m "Development tag $NEW_TAG

        Based on release: ${{ steps.latest_release.outputs.version }}
        Commit: $COMMIT_SHA
        Message: $COMMIT_MESSAGE
        Author: $COMMIT_AUTHOR
        
        Auto-generated on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        Workflow: ${{ github.workflow }}
        Run: ${{ github.run_number }}"
        
        # Push the tag
        git push origin "$NEW_TAG"
        
        echo "✅ Successfully created and pushed tag: $NEW_TAG"

    - name: Tag already exists
      if: steps.tag_exists.outputs.exists == 'true'
      run: |
        echo "ℹ️ Tag ${{ steps.dev_increment.outputs.tag }} already exists, skipping creation"

    - name: Summary
      run: |
        echo "## Auto-tagging Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Latest Release Version:** ${{ steps.latest_release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **New Development Tag:** ${{ steps.dev_increment.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag Created:** ${{ steps.tag_exists.outputs.exists == 'false' && '✅ Yes' || 'ℹ️ Already exists' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow Run:** [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY